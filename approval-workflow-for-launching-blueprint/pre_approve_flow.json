{"status":{},"contains_secrets":false,"product_version":"3.1.1","spec":{"description":"","resources":{"client_attrs":{"f1773acb_deployment":{"y":-307.5,"x":-122}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Push Notification"}],"name":"d1e943ad_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Push Notification","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"7c68109e_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"84a0e6b6_runbook","main_task_local_reference":{"kind":"app_task","name":"d1e943ad_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"d69c48b2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e7094a92_runbook","main_task_local_reference":{"kind":"app_task","name":"d69c48b2_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"20a980bd_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"dc58693e_runbook","main_task_local_reference":{"kind":"app_task","name":"20a980bd_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6e981db0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"92e478e7_runbook","main_task_local_reference":{"kind":"app_task","name":"6e981db0_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"aa9ad39a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d50bb551_runbook","main_task_local_reference":{"kind":"app_task","name":"aa9ad39a_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Playbooks"}],"name":"69eb93e5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Playbooks","attrs":{"exit_status":[],"script":"# create playbook\nimport requests, re\nisdebug = True\n\npc_ip = \"@@{pc_ip}@@\"\njwt = '@@{calm_jwt}@@'\nblueprint_name = \"@@{blueprint_name}@@\"\napplication_uuid = \"@@{calm_application_uuid}@@\"\napplication_name = \"@@{calm_application_name}@@\"\nmsteams_url = \"@@{msteams_url}@@\"\nto_address = \"leiming.pan@nutanix.com\"\n\nif blueprint_name == \"\":\n    exit(9)\n\nheaders = {\n    \"Content-Type\": \"application\/json\",\n    \"Accept\": \"application\/json\",\n    \"Authorization\": \"Bearer {}\".format(jwt),\n    \"Cache-Control\": \"no-cache\"\n}\n\n# get blueprint uuid for launch playbook\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/blueprints\/list\".format(pc_ip)\npostdata = {\"length\": 250}\nr = requests.post(url, headers=headers, verify=False, json=postdata)\nif r.ok:\n    for i in r.json()[\"entities\"]:\n        if blueprint_name == i[\"metadata\"][\"name\"]:\n            print(\"blueprint_uuid={}\".format(i[\"metadata\"][\"uuid\"]))\n            blueprint_uuid = i[\"metadata\"][\"uuid\"]\n            break\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n\n# get blueprint app profile for launch playbook\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/blueprints\/{}\".format(pc_ip, blueprint_uuid)\nr = requests.get(url, headers=headers, verify=False)\nif r.ok:\n    vm = r.json()\n    app_profile_uuid = vm[\"spec\"][\"resources\"][\"app_profile_list\"][0][\"uuid\"]\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n\n# get incoming_webhook_trigger's uuid \/ rest_api_action uuid for all playbook\naction_trigger_type = []\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_trigger_types\/list\".format(pc_ip)\npostdata = {}\nr = requests.post(url, headers=headers, verify=False, json=postdata)\nif r.ok:\n    for i in r.json()[\"entities\"]:\n        action_trigger_type.append({\n            \"name\": i[\"status\"][\"name\"],\n            \"uuid\": i[\"metadata\"][\"uuid\"]\n        })\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n\naction_type = []\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_types\/list\".format(pc_ip)\npostdata = {\"length\":100}\nr = requests.post(url, headers=headers, verify=False, json=postdata)\nif r.ok:\n    for i in r.json()[\"entities\"]:\n        action_type.append({\n            \"name\": i[\"status\"][\"resources\"][\"name\"],\n            \"uuid\": i[\"metadata\"][\"uuid\"]\n        })\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n\n# execute pre-approve playbook to send message to msteams\nfor i in action_trigger_type:\n    if i[\"name\"] == \"incoming_webhook_trigger\":\n        incoming_webhook_trigger_uuid = i[\"uuid\"]\n        break\nfor i in action_type:\n    if i[\"name\"] == \"rest_api_action\":\n        rest_api_action_uuid = i[\"uuid\"]\n        break\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_rules\".format(pc_ip)\npostdata = {\n    \"api_version\": \"3.1\",\n    \"metadata\": {\n        \"kind\": \"action_rule\",\n        \"spec_version\": 0\n    },\n    \"spec\": {\n        \"resources\": {\n            \"name\": \"{}-pre-approve-flow\".format(application_name),\n            \"description\": \"{}-pre-approve-flow\".format(application_name),\n            \"is_enabled\": True,\n            \"trigger_list\": [\n                {\n                    \"action_trigger_type_reference\": {\n                        \"kind\": \"action_trigger_type\",\n                        \"name\": \"incoming_webhook_trigger\",\n                        \"uuid\": incoming_webhook_trigger_uuid\n                    },\n                    \"display_name\": \"Webhook\",\n                    \"input_parameter_values\": {}\n                }\n            ],\n            \"execution_user_reference\": {\n                \"kind\": \"user\",\n                \"name\": \"admin\",\n                \"uuid\": \"00000000-0000-0000-0000-000000000000\"\n            },\n            \"action_list\": [\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"rest_api_action\",\n                        \"uuid\": rest_api_action_uuid\n                    },\n                    \"description\": \"\",\n                    \"display_name\": \"MSTeams\",\n                    \"input_parameter_values\": {\n                        \"method\": \"POST\",\n                        \"request_body\": \"{\\n   \\\"@context\\\": \\\"http:\/\/schema.org\/extensions\\\",\\n   \\\"@type\\\": \\\"MessageCard\\\",\\n   \\\"text\\\": \\\"{{trigger[0].string1}}\\\" \\n}\\n\",\n                        \"url\": msteams_url\n                    },\n                    \"instance_uuid\": \"c4420e59-9287-45b9-aa0d-e51525f57047\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": []\n                }\n            ],\n            \"rule_type\": \"XPLAY\",\n            \"should_validate\": True\n        }\n    }\n}\n\n# replace instance uuid \nnew_uuid = str(uuid.uuid4())\npostdata[\"spec\"][\"resources\"][\"action_list\"][0][\"instance_uuid\"] = new_uuid\n\nr = requests.post(url, headers=headers, verify=False, json=postdata)\n\nif r.ok:\n    pre_approve_playbook_uuid = r.json()[\"metadata\"][\"uuid\"]\n    print(\"pre_approve_playbook_uuid={}\".format(pre_approve_playbook_uuid))\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n\n#============================================\n\n# create launch playbook\nfor i in action_trigger_type:\n    if i[\"name\"] == \"incoming_webhook_trigger\":\n        incoming_webhook_trigger_uuid = i[\"uuid\"]\n        break\nfor i in action_type:\n    if i[\"name\"] == \"rest_api_action\":\n        rest_api_action_uuid = i[\"uuid\"]\n        break\nfor i in action_type:\n    if i[\"name\"] == \"branch_action\":\n        branch_action_uuid = i[\"uuid\"]\n        break\nfor i in action_type:\n    if i[\"name\"] == \"email_action\":\n        email_action_uuid = i[\"uuid\"]\n        break\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_rules\".format(pc_ip)\npostdata = {\n    \"api_version\": \"3.1\",\n    \"metadata\": {\n        \"kind\": \"action_rule\",\n        \"spec_version\": 0\n    },\n    \"spec\": {\n        \"resources\": {\n            \"name\": \"{}-launch-flow\".format(application_name),\n            \"description\": \"{}-launch-flow\".format(application_name),\n            \"is_enabled\": True,\n            \"trigger_list\": [\n                {\n                    \"action_trigger_type_reference\": {\n                        \"kind\": \"action_trigger_type\",\n                        \"name\": \"incoming_webhook_trigger\",\n                        \"uuid\": incoming_webhook_trigger_uuid\n                    },\n                    \"description\": \"\",\n                    \"display_name\": \"Webhook\",\n                    \"input_parameter_values\": {}\n                }\n            ],\n            \"execution_user_reference\": {\n                \"kind\": \"user\",\n                \"name\": \"admin\",\n                \"uuid\": \"00000000-0000-0000-0000-000000000000\"\n            },\n            \"action_list\": [\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"branch_action\",\n                        \"uuid\": branch_action_uuid\n                    },\n                    \"description\": \"@|@|\",\n                    \"display_name\": \"Branch\",\n                    \"input_parameter_values\": {\n                        \"condition\": \"[\\\"if\\\",\\\"if\\\",\\\"else\\\"]\",\n                        \"conditional_expression\": \"[\\\"{0}=={1}\\\",\\\"{2}=={3}\\\"]\",\n                        \"values\": \"[\\\"{{trigger[0].string1}}\\\",\\\"approve\\\",\\\"{{trigger[0].string1}}\\\",\\\"deny\\\"]\",\n                        \"branch\": \"[\\\"d6964626-1b5b-4171-b95b-e9c54a3df34d\\\",\\\"44cb9868-dcfb-481f-9cba-c5c514233678\\\",\\\"b56af79e-9cf1-4366-a9ca-9d1367d273c2\\\"]\"\n                    },\n                    \"instance_uuid\": \"4dcbf986-4a67-4316-8102-94a88cd85777\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": [\n                        \"d6964626-1b5b-4171-b95b-e9c54a3df34d\",\n                        \"44cb9868-dcfb-481f-9cba-c5c514233678\",\n                        \"b56af79e-9cf1-4366-a9ca-9d1367d273c2\"\n                    ]\n                },\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"rest_api_action\",\n                        \"uuid\": rest_api_action_uuid\n                    },\n                    \"description\": \"Launch BP\",\n                    \"display_name\": \"REST API\",\n                    \"input_parameter_values\": {\n                        \"headers\": \"Content-Type: application\/json\\nAuthorization: Bearer %s\" % (jwt),\n                        \"method\": \"POST\",\n                        \"request_body\": \"{\\\"spec\\\": {\\\"app_name\\\": \\\"%s is launched @@{calm_random}@@\\\", \\\"app_description\\\": \\\"Simple launch\\\", \\\"app_profile_reference\\\": {\\\"kind\\\": \\\"app_profile\\\", \\\"uuid\\\": \\\"%s\\\"}, \\\"runtime_editables\\\": {}}}\" % (blueprint_name, app_profile_uuid),\n                        \"url\": \"https:\/\/{}:9440\/api\/nutanix\/v3\/blueprints\/{}\/simple_launch\".format(pc_ip, blueprint_uuid)\n                    },\n                    \"instance_uuid\": \"d6964626-1b5b-4171-b95b-e9c54a3df34d\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": [\n                        \"1bac5f62-012c-4b3a-8e2b-685c3d6e182d\"\n                    ]\n                },\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"rest_api_action\",\n                        \"uuid\": rest_api_action_uuid\n                    },\n                    \"description\": \"Approved Notification\",\n                    \"display_name\": \"REST API\",\n                    \"input_parameter_values\": {\n                        \"headers\": \"Content-Type: application\/json\\nAuthorization: Bearer %s\" % (jwt),\n                        \"method\": \"POST\",\n                        \"request_body\": \"{\\n    \\\"trigger_type\\\": \\\"incoming_webhook_trigger\\\",\\n    \\\"trigger_instance_list\\\": [\\n        {\\n            \\\"webhook_id\\\": \\\"%s\\\",\\n            \\\"string1\\\": \\\"Launch name %s has been <b>Approved<\/b>\\\" \\n        }\\n    ]\\n}\" % (pre_approve_playbook_uuid, application_name),\n                        \"url\": \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_rules\/trigger\".format(pc_ip)\n                    },\n                    \"instance_uuid\": \"1bac5f62-012c-4b3a-8e2b-685c3d6e182d\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": [\n                        \"c27ff6cc-2944-4dd7-9471-9899d48cc100\"\n                    ]\n                },                \n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"email_action\",\n                        \"uuid\": email_action_uuid\n                    },\n                    \"description\": \"approve\",\n                    \"display_name\": \"Email\",\n                    \"input_parameter_values\": {\n                        \"message_body\": \"approve\",\n                        \"subject\": \"test approve\",\n                        \"to_address\": to_address\n                    },\n                    \"instance_uuid\": \"c27ff6cc-2944-4dd7-9471-9899d48cc100\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": []\n                },\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"rest_api_action\",\n                        \"uuid\": rest_api_action_uuid\n                    },\n                    \"description\": \"for deny\",\n                    \"display_name\": \"REST API\",\n                    \"input_parameter_values\": {\n                        \"headers\": \"Content-Type: application\/json\\nAuthorization: Bearer %s\" % (jwt),\n                        \"method\": \"DELETE\",\n                        \"url\": \"https:\/\/{}:9440\/api\/nutanix\/v3\/apps\/{}\".format(pc_ip,application_uuid)\n                    },\n                    \"instance_uuid\": \"44cb9868-dcfb-481f-9cba-c5c514233678\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": [\n                        \"60191a86-db78-4936-b327-043a44438b7c\"\n                    ]\n                },\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"rest_api_action\",\n                        \"uuid\": rest_api_action_uuid\n                    },\n                    \"description\": \"Deny Notification\",\n                    \"display_name\": \"REST API\",\n                    \"input_parameter_values\": {\n                        \"headers\": \"Content-Type: application\/json\\nAuthorization: Bearer %s\" % (jwt),\n                        \"method\": \"POST\",\n                        \"request_body\": \"{\\n    \\\"trigger_type\\\": \\\"incoming_webhook_trigger\\\",\\n    \\\"trigger_instance_list\\\": [\\n        {\\n            \\\"webhook_id\\\": \\\"%s\\\",\\n            \\\"string1\\\": \\\"Launch name %s has been <b>Denied<\/b>\\\" \\n        }\\n    ]\\n}\" % (pre_approve_playbook_uuid, application_name),\n                        \"url\": \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_rules\/trigger\".format(pc_ip)\n                    },\n                    \"instance_uuid\": \"60191a86-db78-4936-b327-043a44438b7c\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": [\n                        \"3f6dba3e-6240-4abb-bac5-b35b00dd4c0c\"\n                    ]\n                },                \n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"email_action\",\n                        \"uuid\": email_action_uuid\n                    },\n                    \"description\": \"deny\",\n                    \"display_name\": \"Email\",\n                    \"input_parameter_values\": {\n                        \"message_body\": \"deny\",\n                        \"subject\": \"test deny\",\n                        \"to_address\": to_address\n                    },\n                    \"instance_uuid\": \"3f6dba3e-6240-4abb-bac5-b35b00dd4c0c\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": []\n                },\n                {\n                    \"action_type_reference\": {\n                        \"kind\": \"action_type\",\n                        \"name\": \"email_action\",\n                        \"uuid\": email_action_uuid\n                    },\n                    \"description\": \"unknown\",\n                    \"display_name\": \"Email\",\n                    \"input_parameter_values\": {\n                        \"message_body\": \"unknown\",\n                        \"subject\": \"test unknown\",\n                        \"to_address\": to_address\n                    },\n                    \"instance_uuid\": \"b56af79e-9cf1-4366-a9ca-9d1367d273c2\",\n                    \"max_retries\": 2,\n                    \"should_continue_on_failure\": False,\n                    \"child_action_uuids\": []\n                }\n            ],\n            \"rule_type\": \"XPLAY\",\n            \"should_validate\": True\n        }\n    }\n}\n\n# replace all instance_uuid\n#print(json.dumps(postdata))\ninstance_uuid_pair = []\naction_number = len(postdata[\"spec\"][\"resources\"][\"action_list\"])\nfor i in range(0, action_number):\n    instance_uuid_pair.append({\n        \"old_one\": postdata[\"spec\"][\"resources\"][\"action_list\"][i][\"instance_uuid\"],\n        \"new_one\": str(uuid.uuid4())\n    })\nfor i in postdata[\"spec\"][\"resources\"][\"action_list\"]:\n    for j in instance_uuid_pair:\n        # replace instance_uuid\n        if i[\"instance_uuid\"] == j[\"old_one\"]:\n            i[\"instance_uuid\"] = j[\"new_one\"]\n        # replace child_action_uuids list\n        for k,v in enumerate(i[\"child_action_uuids\"]):\n            if v == j[\"old_one\"]:\n                i[\"child_action_uuids\"][k] = j[\"new_one\"]\n        # replace uuid in branch action\n        if i[\"action_type_reference\"][\"name\"] == \"branch_action\":\n            i[\"input_parameter_values\"][\"branch\"] = re.sub(j[\"old_one\"], j[\"new_one\"], i[\"input_parameter_values\"][\"branch\"])\n#print(json.dumps(postdata))\n\nr = requests.post(url, headers=headers, verify=False, json=postdata)\nif r.ok:\n    print(\"launch_playbook_uuid={}\".format(r.json()[\"metadata\"][\"uuid\"]))\n    launch_playbook_uuid = r.json()[\"metadata\"][\"uuid\"]\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n\n\n\n","eval_variables":["launch_playbook_uuid","pre_approve_playbook_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"0e2626db_runbook","main_task_local_reference":{"kind":"app_task","name":"69eb93e5_dag"},"variable_list":[]},"name":"Create Playbooks"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"clean"}],"name":"841c7e5c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"clean","attrs":{"script":"# clean playbook\nimport requests\nisdebug = True\n\nuuid = []\nuuid.append(\"@@{pre_approve_playbook_uuid}@@\")\nuuid.append(\"@@{launch_playbook_uuid}@@\")\n\nprint(uuid)\n\npc_ip = \"@@{pc_ip}@@\"\njwt = '@@{calm_jwt}@@'\n\nheaders = {\n    \"Content-Type\": \"application\/json\",\n    \"Accept\": \"application\/json\",\n    \"Authorization\": \"Bearer {}\".format(jwt),\n    \"Cache-Control\": \"no-cache\"\n}\n\n# delete\nfor i in uuid:\n    url = \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_rules\/{}\".format(pc_ip, i)\n    r = requests.delete(url, headers=headers, verify=False)\n    if r.ok:\n        print r.status_code\n        print r.text\n    else:\n        print r.status_code\n        print r.text\n        exit(9)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"2c9d089b_runbook","main_task_local_reference":{"kind":"app_task","name":"841c7e5c_dag"},"variable_list":[]},"name":"Clean playbook"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"run pre_approve playbook"}],"name":"35e55003_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"run pre_approve playbook","attrs":{"script":"# clean playbook\nimport requests\nisdebug = True\n\npre_approve_playbook_uuid = \"@@{pre_approve_playbook_uuid}@@\"\nlaunch_playbook_uuid = \"@@{launch_playbook_uuid}@@\"\napplication_name = \"@@{calm_application_name}@@\"\nticket_ip = \"@@{ticket_ip}@@\"\nticket_port = \"@@{ticket_port}@@\"\npc_ip = \"@@{pc_ip}@@\"\njwt = '@@{calm_jwt}@@'\n\nheaders = {\n    \"Content-Type\": \"application\/json\",\n    \"Accept\": \"application\/json\",\n    \"Authorization\": \"Bearer {}\".format(jwt),\n    \"Cache-Control\": \"no-cache\"\n}\n\n# generate text for msteams and change to url string\nmytext = '{\"trigger_type\":\"incoming_webhook_trigger\",\"trigger_instance_list\":[{\"webhook_id\":\"%s\",\"string1\":\"approve\"}]}' % (launch_playbook_uuid)\n#mytext = re.sub(\"%\", \"%40\", mytext)\nmytext = re.sub(\"{\", \"%7B\", mytext)\nmytext = re.sub(\"}\", \"%7D\", mytext)\nmytext = re.sub(\"\\[\", \"%5B\", mytext)\nmytext = re.sub(\"]\", \"%5D\", mytext)\nmytext = re.sub(\":\", \"%3A\", mytext)\nmytext = re.sub(\"\\\"\", \"%22\", mytext)\nmytext = re.sub(\" \", \"%20\", mytext)\nmytext = re.sub(\",\", \"%2C\", mytext)\nmytext = re.sub(\";\", \"%3B\", mytext)\nmytext_deny = re.sub(\"approve\", \"deny\", mytext)\n\n# should be like \n# %7B%20%20%22trigger_type%22%3A%20%22incoming_webhook_trigger%22%2C%20%20%22trigger_instance_list%22%3A%20%5B%7B%20%20%20%20%22webhook_id%22%3A%20%229e5d8034-7abb-49d6-9f30-c368d9d0faaf%22%2C%20%20%20%20%22string1%22%3A%20%22approve%22%20%20%7D%5D%7D%0A\n# %7B%20%20%22trigger_type%22%3A%20%22incoming_webhook_trigger%22%2C%20%20%22trigger_instance_list%22%3A%20%5B%7B%20%20%20%20%22webhook_id%22%3A%20%229e5d8034-7abb-49d6-9f30-c368d9d0faaf%22%2C%20%20%20%20%22string1%22%3A%20%22deny%22%20%20%7D%5D%7D%0A\n\n\n# delete\nurl = \"https:\/\/{}:9440\/api\/nutanix\/v3\/action_rules\/trigger\".format(pc_ip)\npostdata = {\n    \"trigger_type\": \"incoming_webhook_trigger\",\n    \"trigger_instance_list\": [\n        {\n            \"webhook_id\": pre_approve_playbook_uuid,\n            \"string1\": \"Launch name %s is waiting for your approval. Please click to <a href=\\\\\\\"http:\/\/%s:%s\/%s\\\\\\\">APPROVE<\/a> this action or <a href=\\\\\\\"http:\/\/%s:%s\/%s\\\\\\\">DENY<\/a>\" % (application_name, ticket_ip, ticket_port, mytext, ticket_ip, ticket_port, mytext_deny)\n        }\n    ]\n}\nr = requests.post(url, headers=headers, verify=False, json=postdata)\nprint(json.dumps(postdata))\nif r.ok:\n    print r.status_code\n    print r.text\nelse:\n    print r.status_code\n    print r.text\n    exit(9)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"7c68109e_runbook","main_task_local_reference":{"kind":"app_task","name":"35e55003_dag"},"variable_list":[]},"name":"Push Notification"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"pre_approve_playbook_uuid","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"launch_playbook_uuid","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"EXISTING_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":true},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"0.0.0.0"},"variable_list":[]}],"credential_definition_list":[{"username":"null","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"null"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Playbook"}],"name":"26114fc5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Playbook","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"0e2626db_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"9a26c1bc_runbook","main_task_local_reference":{"kind":"app_task","name":"26114fc5_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"clean playbook"}],"name":"45deabbd_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"clean playbook","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"2c9d089b_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"b271e422_runbook","main_task_local_reference":{"kind":"app_task","name":"45deabbd_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"f1773acb_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"ticket_port","value":"5000","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"ticket_ip","value":"localhost","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"msteams_url","value":"https:\/\/outlook.office.com\/webhook\/88eae64b-f6bd-4f96-874f-795ed0efc2f5@bb047546-786f-4de1-bd75-24e5b6f79043\/IncomingWebhook\/e03bf845587744f8a0d034da917a0696\/2591ac3b-a500-441b-b9c8-079006eb9020","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"pc_ip","value":"10.55.7.40","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"EXEC_LOCAL","name":"blueprint_name","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"import requests\nisdebug = True\npc_ip = \"@@{pc_ip}@@\"\npc_user = \"admin\"\npc_pass = \"password\"\n\nurl = \"https:\/\/%s:9440\/api\/nutanix\/v3\/blueprints\/list\" % (pc_ip)\ntoken = base64.b64encode(\"{}:{}\".format(pc_user, pc_pass))\n\nheaders = {\n    \"Content-Type\": \"application\/json\",\n    \"Accept\": \"application\/json\",\n    \"Authorization\": \"Basic %s\" % token,\n    \"Cache-Control\": \"no-cache\"\n}\n\npostdata = {\"length\": 250}\n\na = []\nr = requests.post(url, headers=headers, verify=False, json=postdata)\nif r.ok:\n  for i in r.json()[\"entities\"]:\n    a.append(i[\"metadata\"][\"name\"])\n  print(','.join(a))\nelse:\n    print r.status_code\n    print r.text\n","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"null"},"type":"USER"},"name":"pre_approve_flow"},"api_version":"3.0","metadata":{"last_update_time":"1609380017876979","kind":"blueprint","spec_version":73,"creation_time":"1608861860595786","name":"pre_approve_flow"}}
