{"status":{},"product_version":"2.7.1.1","spec":{"description":"MySQL blueprint with some nice actions connected to a wordpress.\nDB password need to be set without special characters otherwise wordpress script will interpret the password in the wrong way.","resources":{"client_attrs":{"None":{"y":160,"x":541},"3dde34f6_deployment":{"y":-85,"x":422},"0de3847c_deployment":{"y":-13,"x":861}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"14c8fe8d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f603ab76_runbook","main_task_local_reference":{"kind":"app_task","name":"14c8fe8d_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6268e978_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d738eefe_runbook","main_task_local_reference":{"kind":"app_task","name":"6268e978_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"11f7e9b6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7748f46a_runbook","main_task_local_reference":{"kind":"app_task","name":"11f7e9b6_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"52def80e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"534c563f_runbook","main_task_local_reference":{"kind":"app_task","name":"52def80e_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1b587922_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e9d7de80_runbook","main_task_local_reference":{"kind":"app_task","name":"1b587922_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"MySQLService","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"14c8fe8d_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f603ab76_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"14c8fe8d_dag_cloned_1"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6268e978_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d738eefe_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"6268e978_dag_cloned_1"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"11f7e9b6_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7748f46a_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"11f7e9b6_dag_cloned_1"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"52def80e_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"534c563f_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"52def80e_dag_cloned_1"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1b587922_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e9d7de80_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"1b587922_dag_cloned_1"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[{"kind":"app_service","name":"MySQLService"}],"name":"WordPress","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"MySQL"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e4917780_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"151bc7f0_runbook","main_task_local_reference":{"kind":"app_task","name":"e4917780_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"MySQL"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"41749446_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a48a61d2_runbook","main_task_local_reference":{"kind":"app_task","name":"41749446_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"MySQL","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"readiness_probe":{"connection_type":true,"connection_port":true,"timeout_secs":true},"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"num_vcpus_per_socket":true,"num_sockets":true,"memory_size_mib":true,"guest_customization":true,"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{calm_application_name}@@mysql","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"04d9d1f3-566a-44f9-9cfe-cc25891c4ee4"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{INSTANCE_PUBLIC_KEY}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-7-cloudinit","uuid":"8066b92e-9acc-4bce-ad1f-cf808b234a5a"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":2,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":3,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":51200,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":4,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":5,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":6,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":7,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":25600,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":8,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"Wordpress","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"45","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"readiness_probe":{"connection_type":true,"connection_port":true,"timeout_secs":true},"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"num_vcpus_per_socket":true,"num_sockets":true,"memory_size_mib":true,"guest_customization":true,"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{calm_application_name}@@wordpress","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"04d9d1f3-566a-44f9-9cfe-cc25891c4ee4"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{INSTANCE_PUBLIC_KEY}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-7-cloudinit","uuid":"8066b92e-9acc-4bce-ad1f-cf808b234a5a"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS","editables":{"username":true,"secret":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"MySQLService"}],"name":"AHVMySQLPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"AHVMySQLPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Install System Packages"},{"kind":"app_task","name":"Create Disk Setup"},{"kind":"app_task","name":"Install MySQL"},{"kind":"app_task","name":"Setup MySQL"},{"kind":"app_task","name":"Epoch"},{"kind":"app_task","name":"Epoch_mySQL_config"},{"kind":"app_task","name":"install_system_tools"},{"kind":"app_task","name":"createdb_wordpress_adn_user"}],"name":"d80995e3_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install System Packages"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Disk Setup"}},{"from_task_reference":{"kind":"app_task","name":"Create Disk Setup"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install MySQL"}},{"from_task_reference":{"kind":"app_task","name":"Install MySQL"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Setup MySQL"}},{"from_task_reference":{"kind":"app_task","name":"Setup MySQL"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Epoch"}},{"from_task_reference":{"kind":"app_task","name":"Epoch"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Epoch_mySQL_config"}},{"from_task_reference":{"kind":"app_task","name":"Epoch_mySQL_config"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"install_system_tools"}},{"from_task_reference":{"kind":"app_task","name":"install_system_tools"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"createdb_wordpress_adn_user"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Install System Packages","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# -*- Install Mysql\nsudo yum update -y --quiet\nsudo yum install -y  htop wget iotop xfs* bc unzip lvm2*\n\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/sysconfig\/selinux\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/selinux\/config\nsudo setenforce 0\n\necho \"System packages are installed\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Create Disk Setup","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n##############\n#\n# LVM setup script for MySQL . 4 disks for DATA and 4 for logs\n# Data disks are 50GB | Log disks are 25GB \n#\n#############\n\n\n#PGSQL data\nsudo pvcreate \/dev\/sdb \/dev\/sdc \/dev\/sdd \/dev\/sde\nsudo vgcreate mysqlDataVG \/dev\/sdb \/dev\/sdd \/dev\/sdc \/dev\/sde\nsudo lvcreate -l 100%FREE -i4 -I1M -n mysqlDataLV mysqlDataVG          ## Use 1MB to avoid IO amplification \n#lvcreate -l 100%FREE -i4 -I4M -n pgDataLV pgDataVG\n\n\n#PGSQL logs\nsudo pvcreate \/dev\/sdf \/dev\/sdg \/dev\/sdh \/dev\/sdi\nsudo vgcreate mysqlLogVG \/dev\/sdf \/dev\/sdg \/dev\/sdh \/dev\/sdi\nsudo lvcreate -l 100%FREE -i2 -I1M -n mysqlLogLV mysqlLogVG            ## Use 1MB to avoid IO amplification\n#lvcreate -l 100%FREE -i2 -I4M -n pgLogLV pgLogVG\n\n\n#Disable LVM read ahead\nsudo lvchange -r 0 \/dev\/mysqlDataVG\/mysqlDataLV\nsudo lvchange -r 0 \/dev\/mysqlLogVG\/mysqlLogLV\n\n\n#Format LVMs with ext4 and use nodiscard to make sure format time is fast on Nutanix due to SCSI unmap\nsudo mkfs.ext4 -E nodiscard \/dev\/mysqlDataVG\/mysqlDataLV\nsudo mkfs.ext4 -E nodiscard \/dev\/mysqlLogVG\/mysqlLogLV\n\nsleep 30\n\n\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Install MySQL","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\nsudo hostnamectl set-hostname \"@@{name}@@\"\n\n# -*- Mysql installation \nsudo yum install -y --quiet \"http:\/\/repo.mysql.com\/mysql80-community-release-el7.rpm\"\nsudo yum update -y --quiet\nsudo yum install -y --quiet sshpass mysql-community-server.x86_64\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Setup MySQL","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n\necho \"!includedir \/etc\/my.cnf.d\" | sudo tee -a \/etc\/my.cnf\n\necho \"[mysqld]\nbinlog-format=mixed\nlog-bin=mysql-bin\ndatadir=\/mysql\/data\nsql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES\ninnodb_data_home_dir = \/mysql\/data\ninnodb_log_group_home_dir = \/mysql\/log\ninnodb_file_per_table\ntmpdir=\/mysql\/tmpdir\ninnodb_undo_directory = \/mysql\/undo\ndefault-storage-engine = innodb\ndefault_tmp_storage_engine = innodb\ninnodb_log_files_in_group = 4\ninnodb_log_file_size = 1G\ninnodb_log_buffer_size = 8M\ninnodb_buffer_pool_size = 6G\t\nlarge-pages\t\ninnodb_buffer_pool_instances = 64\t\ninnodb_flush_method=O_DIRECT\t\ninnodb_flush_neighbors=0\t \ninnodb_flush_log_at_trx_commit=1\ninnodb_buffer_pool_dump_at_shutdown=1\t\ninnodb_buffer_pool_load_at_startup=1\t\nbulk_insert_buffer_size = 256\t\ninnodb_thread_concurrency = 16\t\n \t \n# Undo tablespace\t \ninnodb_undo_tablespaces = 5\t\n \t \n# Networking\t \nwait_timeout=57600\t \nmax_allowed_packet=1G\t\nsocket=\/var\/lib\/mysql\/mysql.sock\t \nskip-name-resolve\nport=3306\t\nmax_connections=1000\t\n\n\n[mysqld_safe]\nlog-error=\/mysql\/log\/mysqld.log\npid-file=\/var\/run\/mysqld\/mysqld.pid\" | sudo tee \/etc\/my.cnf.d\/nutanix.cnf\n\nsudo sed -i \"\/\\[mysqld\\]\/a server-id=100\" \/etc\/my.cnf.d\/nutanix.cnf\n\n\n# -*- Sysctl configuration\nmysql_grp_id=`id -g mysql`\nsudo sysctl -w vm.swappiness=0\nsudo sysctl -w vm.nr_hugepages=1024\nsudo sysctl -w vm.overcommit_memory=1\nsudo sysctl -w vm.dirty_background_ratio=5 \nsudo sysctl -w vm.dirty_ratio=15\nsudo sysctl -w vm.dirty_expire_centisecs=500\nsudo sysctl -w vm.dirty_writeback_centisecs=100\nsudo sysctl -w vm.hugetlb_shm_group=$mysql_grp_id\n\necho \"vm.swappiness=0\nvm.nr_hugepages=1024\nvm.overcommit_memory=1\nvm.dirty_background_ratio=5 \nvm.dirty_ratio=15\nvm.dirty_expire_centisecs=500\nvm.dirty_writeback_centisecs=100\nvm.hugetlb_shm_group=$mysql_grp_id\" | sudo tee  -a \/etc\/sysctl.conf\n\necho \"ACTION=='add|change', SUBSYSTEM=='block', RUN+='\/bin\/sh -c \\\"\/bin\/echo 1024 > \/sys%p\/queue\/max_sectors_kb\\\"'\" | sudo tee \/etc\/udev\/rules.d\/71-block-max-sectors.rules\n#echo 1024 | sudo tee \/sys\/block\/sd?\/queue\/max_sectors_kb\n\necho \"\/dev\/mysqlDataVG\/mysqlDataLV \/mysql\/data ext4 rw,seclabel,noatime,nobarrier,stripe=4096,data=ordered 0 0\" | sudo tee -a \/etc\/fstab\necho \"\/dev\/mysqlLogVG\/mysqlLogLV \/mysql\/log ext4 rw,seclabel,noatime,nobarrier,stripe=4096,data=ordered 0 0\" | sudo tee -a \/etc\/fstab\nsudo mkdir -p \/mysql\/log \/mysql\/data \/mysql\/tmpdir \/mysql\/undo\nsudo mount -a\nsudo chown -R mysql:mysql \/mysql\n\nsudo systemctl enable mysqld\n\nsudo rm -rf \/mysql\/data\/*\nsudo systemctl start mysqld\n\n#Fix to obtain temp password and set it to blank\npassword=$(sudo grep -oP 'temporary password(.*): \\K(\\S+)' \/var\/log\/mysqld.log)\nsudo mysqladmin --user=root --password=\"$password\" password aaBB**cc1122\nsudo mysql --user=root --password=aaBB**cc1122 -e \"UNINSTALL COMPONENT 'file:\/\/component_validate_password'\"\nsudo mysqladmin --user=root --password=\"aaBB**cc1122\" password \"\"\n\n\n#Mysql secure installation\nsudo mysql -u root<<-EOF\nALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY '@@{MYSQL_PASSWORD}@@';\nDELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');\nDELETE FROM mysql.user WHERE User='';\nDELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';\nFLUSH PRIVILEGES;\nEOF\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Epoch","state":"ACTIVE","attrs":{"script":"# Download the collectors with the command\nsudo wget -q -O \\\n      epoch-collectors.rpm \\\n      https:\/\/repo.epoch.nutanix.com\/stable\/epoch-collectors-centos-7-x64.rpm\n\n# Install the collectors\nsudo rpm -i -U --replacefiles --replacepkgs epoch-collectors.rpm\n\n# Configure the collectors.\nsudo EPOCH_AOC_HOST=@@{EPOCH_HOST}@@ EPOCH_ORGANIZATION_ID=@@{EPOCH_ORG_ID}@@ EPOCH_INTERFACE=any EPOCH_ANALYSIS_DEPTH=layer7 EPOCH_L7_SAMPLINGRATE=20  \/opt\/nutanix\/epoch\/collectors\/configure.sh\n\n# Start the collectors\nsudo \/etc\/init.d\/epoch-collectors start\nsudo rm -f epoch-collectors.rpm","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Epoch_mySQL_config","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\n\nif [ $running = 1 ]; then\n\techo db is running\n\tsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"CREATE USER 'epoch'@'%%' IDENTIFIED BY '@@{MYSQL_PASSWORD}@@';\"\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"GRANT REPLICATION CLIENT ON *.* TO 'epoch'@'%%';\"\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"ALTER USER 'epoch'@'%%' WITH MAX_USER_CONNECTIONS 5;\"\n\tsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"GRANT PROCESS ON *.* TO 'epoch'@'%%';\"\n\tsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"GRANT SELECT ON performance_schema.* TO 'epoch'@'%%';\"\nelse\n\techo db is not running\n\techo issuing a start\n\tsudo systemctl start mysqld\nfi\n\nsudo \/etc\/init.d\/epoch-collectors restart\n\nsleep 60\n\nsudo \/etc\/init.d\/epoch-collectors info\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"install_system_tools","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\necho installing zip utility\nsudo yum -y install bzip2\n\necho installing sysstat for sar\nsudo yum -y install sysstat\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"createdb_wordpress_adn_user","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\n\nif [ $running = 1 ]; then\n\techo db is running\n\tsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"CREATE USER 'wpuser'@'%%' IDENTIFIED WITH mysql_native_password BY '@@{MYSQL_PASSWORD}@@';\"\n\tsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"GRANT PROCESS ON *.* TO 'wpuser'@'%%';\"\n\tsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"CREATE DATABASE wordpress;\"\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"GRANT ALL PRIVILEGES on wordpress.* to 'wpuser'@'%%';\"\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e \"FLUSH PRIVILEGES;\"\nelse\n\techo db is not running\n\techo issuing a start\n\tsudo systemctl start mysqld\nfi\n\nsudo systemctl restart mysqld.service","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"ecae87f8_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"d80995e3_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"AHVMySQLPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"254e5361_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2ac89dfe_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"254e5361_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"CENTOS_IMAGE","version":"","options":{"type":"","name":"Centos-7.4-1801-01","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/download.nutanix.com\/calm\/CentOS-7-x86_64-GenericCloud-1801-01.qcow2","version":{"product_version":"","type":"","product_name":""},"architecture":"X86_64","type":""},"description":""},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"WordPress"}],"name":"AHVWordPressPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"AHVWordPressPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Install System Packages Apache PHP"},{"kind":"app_task","name":"Epoch"},{"kind":"app_task","name":"install_system_tools"},{"kind":"app_task","name":"wordpress"},{"kind":"app_task","name":"WP_automatic_install"},{"kind":"app_task","name":"initialize epoch"}],"name":"d80995e3_dag_cloned_1","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Epoch"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"install_system_tools"}},{"from_task_reference":{"kind":"app_task","name":"install_system_tools"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"wordpress"}},{"from_task_reference":{"kind":"app_task","name":"Install System Packages Apache PHP"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Epoch"}},{"from_task_reference":{"kind":"app_task","name":"wordpress"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"WP_automatic_install"}},{"from_task_reference":{"kind":"app_task","name":"WP_automatic_install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"initialize epoch"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Install System Packages Apache PHP","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# -*- Install packages\nsudo yum update -y --quiet\nsudo yum install -y  htop wget iotop xfs* bc unzip lvm2*\n\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/sysconfig\/selinux\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/selinux\/config\nsudo setenforce 0\n\necho \"System packages are installed\"\n\nsudo yum -y install http:\/\/rpms.remirepo.net\/enterprise\/remi-release-7.rpm\nsudo yum install http:\/\/rpms.remirepo.net\/fedora\/remi-release-29.rpm\nsudo yum install yum-utils\nsudo yum-config-manager --disable remi-php54\nsudo yum-config-manager --enable remi-php73\n   \n# Install Apache and PHP\nsudo yum install -y --quiet httpd openssl mod_ssl\n\nsudo yum install -y --quiet httpd openssl mod_ssl php php-common php-mysql php-gd php-xml php-mbstring php-mcrypt\n\nsudo systemctl restart httpd\nsudo systemctl enable httpd\n\necho Apache and PHP installed \n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Epoch","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Download the collectors with the command\nsudo hostnamectl set-hostname \"@@{name}@@\"\n\nsudo wget -q -O \\\n      epoch-collectors.rpm \\\n      https:\/\/repo.epoch.nutanix.com\/stable\/epoch-collectors-centos-7-x64.rpm\n\n# Install the collectors\nsudo rpm -i -U --replacefiles --replacepkgs epoch-collectors.rpm\n\n# Configure the collectors.\nsudo EPOCH_AOC_HOST=@@{EPOCH_HOST}@@ EPOCH_ORGANIZATION_ID=@@{EPOCH_ORG_ID}@@ EPOCH_INTERFACE=any EPOCH_ANALYSIS_DEPTH=layer7 EPOCH_L7_SAMPLINGRATE=20  \/opt\/nutanix\/epoch\/collectors\/configure.sh\n\n#configure hosts file\n\n# Start the collectors\n# sudo \/etc\/init.d\/epoch-collectors start\nsudo rm -f epoch-collectors.rpm","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"install_system_tools","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\necho installing zip utility\nsudo yum -y install bzip2 perl\n\necho installing sysstat for sar\nsudo yum -y install sysstat\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"wordpress","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n\nset -ex\n\nsudo hostnamectl set-hostname \"@@{name}@@\"\n\n# download latest wget\nsudo wget http:\/\/wordpress.org\/latest.zip\n\nsudo unzip -q latest.zip -d \/var\/www\/html\/\n\nsudo chown -R apache:apache \/var\/www\/html\/wordpress\nsudo chmod -R 755 \/var\/www\/html\/wordpress\n\nsudo mkdir -p \/var\/www\/html\/wordpress\/wp-content\/uploads\nsudo chown -R apache:apache \/var\/www\/html\/wordpress\/wp-content\/uploads\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"WP_automatic_install","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash -e\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n\necho \"============================================\"\necho \"WordPress Install Script\"\necho \"============================================\"\n\ndbhost=@@{MySQLService.address}@@\necho \"Database host :\" $dbhost\n\ndbname=wordpress\necho \"Database Name: \" $dbname\n\ndbuser=wpuser\necho \"Database User: \" $dbuser\n\ndbpass=@@{MYSQL_PASSWORD}@@\necho \"Database Password: \" $dbpass\n\necho \"============================================\"\necho \"A robot is now installing WordPress for you.\"\necho \"============================================\"\n\ncd \/var\/www\/html\/wordpress\nsudo cp wp-config-sample.php wp-config.php\n\n#set database details with perl find and replace\nsudo perl -pi -e \"s\/database_name_here\/$dbname\/g\" wp-config.php\nsudo perl -pi -e \"s\/username_here\/$dbuser\/g\" wp-config.php\nsudo perl -pi -e \"s\/password_here\/$dbpass\/g\" wp-config.php\nsudo perl -pi -e \"s\/localhost\/$dbhost\/g\" wp-config.php\n\n\n#set WP salts\nsudo perl -i -pe'\n  BEGIN {\n    @chars = (\"a\" .. \"z\", \"A\" .. \"Z\", 0 .. 9);\n    push @chars, split \/\/, \"!@#$%^&*()-_ []{}<>~\\`+=,.;:\/?|\";\n    sub salt { join \"\", map $chars[ rand @chars ], 1 .. 64 }\n  }\n  s\/put your unique phrase here\/salt()\/ge\n' wp-config.php\n\n#create uploads folder and set permissions\nsudo chown apache:apache wp-config.php","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"initialize epoch","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash -e\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n\n#confgirure hosts file\n\nethernet=`sudo ifconfig eth0 | grep inet | grep netmask | awk '{print $2}'`\necho $ethernet\n\nhostname=`hostname`\necho $hostname\n\nsudo chmod 777 \/etc\/hosts\nsudo echo \"$ethernet    $hostname\" >> \/etc\/hosts\nsudo chmod 644 \/etc\/hosts\n\nsudo \/etc\/init.d\/epoch-collectors start\nsleep 30\nsudo \/etc\/init.d\/epoch-collectors info\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"ecae87f8_runbook_cloned_0","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"d80995e3_dag_cloned_1"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"AHVWordPressPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"254e5361_dag_cloned_1","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2ac89dfe_runbook_cloned_0","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"254e5361_dag_cloned_1"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"3dde34f6_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"AHVMySQLPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"MySQL"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"0de3847c_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"AHVWordPressPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"Wordpress"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[{"description":"Take DB Backup. Specify absolute directory path for BACKUP_FILE_PATH","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Do DB Backup"},{"kind":"app_task","name":"Do DB Backup_cloned_1"}],"name":"cad80330_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Do DB Backup","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n### Setup variables\nmysql_password=\"@@{MYSQL_PASSWORD}@@\"\ndate_part=`date +%F`\nmkdir -p @@{BACKUP_FILE_PATH}@@\nsudo mysqldump -u root -p${mysql_password} --all-databases | sudo gzip -9 > @@{BACKUP_FILE_PATH}@@\/db_dump.sql.gz","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Do DB Backup_cloned_1","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n### Setup variables\nmysql_password=\"@@{MYSQL_PASSWORD}@@\"\ndate_part=`date +%F`\nmkdir -p @@{BACKUP_FILE_PATH}@@\nsudo mysqldump -u root -p${mysql_password} --all-databases | sudo gzip -9 > @@{BACKUP_FILE_PATH}@@\/db_dump.sql.gz","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"5f2baec7_runbook","main_task_local_reference":{"kind":"app_task","name":"cad80330_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"BACKUP_FILE_PATH","value":"~\/db_backup","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false}]},"name":"Backup"},{"description":"To restore DB from dump file. Specify absolute directory path for RESTORE_FILE_PATH","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Do DB Restore"},{"kind":"app_task","name":"Do DB Restore_cloned_1"}],"name":"f0946ced_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Do DB Restore","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n### Setup variables\nmysql_password=\"@@{MYSQL_PASSWORD}@@\"\ndb_file=@@{RESTORE_FILE_PATH}@@\n\nsudo gunzip < $db_file | sudo mysql -u root -p${mysql_password} ","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"WordPress"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Do DB Restore_cloned_1","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n### Setup variables\nmysql_password=\"@@{MYSQL_PASSWORD}@@\"\ndb_file=@@{RESTORE_FILE_PATH}@@\n\nsudo gunzip < $db_file | sudo mysql -u root -p${mysql_password} ","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"0734309b_runbook","main_task_local_reference":{"kind":"app_task","name":"f0946ced_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"RESTORE_FILE_PATH","value":"~\/db_backup\/db_dump.sql.gz","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false}]},"name":"Restore"},{"description":"this action will restart DB","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"start_mysql"}],"name":"09a0d013_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"start_mysql","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\n\nif [ $running = 1 ]; then\n\techo db is already running\nelse\n\techo restart is required\n\tsudo systemctl start mysqld\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"bd786b05_runbook","main_task_local_reference":{"kind":"app_task","name":"09a0d013_dag"},"variable_list":[]},"name":"MySQL_start"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"stop_mySQL"}],"name":"a3925ed3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"stop_mySQL","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\n\nif [ $running = 0 ]; then\n\techo db is already stopped\nelse\n\techo stop db\n\tsudo systemctl stop mysqld\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"dd038c5f_runbook","main_task_local_reference":{"kind":"app_task","name":"a3925ed3_dag"},"variable_list":[]},"name":"MySQL_stop"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"health_check"}],"name":"a8570e82_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"health_check","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\nif [ $running = 1 ]; then\n    echo db is running\n    echo \"\nSHOW DATABASES;     \nCREATE DATABASE Nutanix;\nSHOW DATABASES;     \nUSE Nutanix;\n\nCREATE TABLE shop (\n    article INT(4) UNSIGNED ZEROFILL DEFAULT '0000' NOT NULL,\n    dealer  CHAR(20)                 DEFAULT ''     NOT NULL,\n    price   DOUBLE(16,2)             DEFAULT '0.00' NOT NULL,\n    PRIMARY KEY(article, dealer));\nINSERT INTO shop VALUES\n    (1,'AHV',3.45),(1,'AOS',3.99),(2,'AFS',10.99),(3,'AOS',1.45),\n    (7,'Xi Leap',8.35),(1,'Volumes',0.69),(2,'Xi IoT',0.73),(3,'Xi VM',6.45),\n    (3,'AHV',1.69),(3,'Karbon',1.25),(4,'Calm',19.95),(5,'Buckets',29.05) ;\n\nSELECT * FROM shop ORDER BY price;\n\nSELECT BENCHMARK(10000000,1+2+3+4);\nSELECT BENCHMARK(10000000,1+2+3+4);\nSELECT BENCHMARK(10000000,1+2+3+4);\n\nSELECT * FROM shop ORDER BY dealer;\n\nSELECT BENCHMARK(10000000,1+2+3+4);\nSELECT BENCHMARK(10000000,1+2+3+4);\nSELECT BENCHMARK(10000000,1+2+3+4);\n\nSELECT * FROM shop ORDER BY article;\n\nDROP DATABASE Nutanix;\n\" | sudo tee \/tmp\/health_checks.txt\n    \n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e status | grep Threads > \/tmp\/status.txt\n    Threads=`cat \/tmp\/status.txt | awk '{print $2}'`\n    echo number of Threads is $Threads\n    Slow_Query=`cat \/tmp\/status.txt | awk '{print $7}'`\n    echo Slow_Query are equal to $Slow_Query\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' < \/tmp\/health_checks.txt\nelse\n    echo db is not running\n    echo issuing a start\n    sudo systemctl start mysqld\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"63bb8ed8_runbook","main_task_local_reference":{"kind":"app_task","name":"a8570e82_dag"},"variable_list":[]},"name":"Check_health_mysql"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"show_databases"}],"name":"5f081996_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"show_databases","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\necho \"\nSHOW DATABASES; \n\" | sudo tee \/tmp\/show_info.txt\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\n\nif [ $running = 1 ]; then\n\techo db is running\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' < \/tmp\/show_info.txt\nelse\n\techo db is not running\n\techo issuing a start\n\tsudo systemctl start mysqld\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"50f14615_runbook","main_task_local_reference":{"kind":"app_task","name":"5f081996_dag"},"variable_list":[]},"name":"show_databases"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Benchmark"}],"name":"e0273eb3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Benchmark","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\necho \"SELECT BENCHMARK(10000000,1+2+3+4);\" | sudo tee \/tmp\/benchmark.txt\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\nif [ $running = 1 ]; then\n\techo db is running\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@'< \/tmp\/benchmark.txt\nelse\n\techo db is not running\n\techo issuing a start\n\tsudo systemctl start mysqld\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"4478251d_runbook","main_task_local_reference":{"kind":"app_task","name":"e0273eb3_dag"},"variable_list":[]},"name":"CPU_benchmark"},{"description":"autogenerate queries","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"mysqlslap_employee_db"}],"name":"e0273eb3_dag_cloned_1_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"mysqlslap_employee_db","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\nsudo mkdir employees_db\nsudo chmod 777 employees_db\nsudo wget https:\/\/launchpad.net\/test-db\/employees-db-1\/1.0.6\/+download\/employees_db-full-1.0.6.tar.bz2\nsudo mv employees_db-full-1.0.6.tar.bz2 employees_db\/\necho unzipping db\nsudo bzip2 -dfv employees_db\/employees_db-full-1.0.6.tar.bz2\necho untarring db\nsudo tar -xf employees_db\/employees_db-full-1.0.6.tar\necho done untar db\n\nsudo mv employees_db\/*.dump .\/\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\nif [ $running = 1 ]; then\n    echo db is running\n    sudo grep -v storage_engine employees_db\/employees.sql > employees_db\/employees_no_engine.sql\n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' < employees_db\/employees_no_engine.sql\n    \n    echo db created\n    \n    sudo mysqlslap --user=root --password='@@{MYSQL_PASSWORD}@@' --concurrency=50 --iterations=20 --number-int-cols=2 --number-char-cols=3 --auto-generate-sql --verbose\n    sudo mysqlslap --user=root --password='@@{MYSQL_PASSWORD}@@' --concurrency=100 --iterations=3 --create-schema=employees --query=\"SELECT * FROM dept_emp;\" --verbose\n    sudo mysqlslap --user=root --password='@@{MYSQL_PASSWORD}@@' --concurrency=10 --iterations=3 --create-schema=employees --query=\"SELECT e.first_name, e.last_name, d.dept_name, t.title, t.from_date, t.to_date FROM employees e INNER JOIN  dept_emp de ON e.emp_no=de.emp_no INNER JOIN departments d ON de.dept_no=d.dept_no INNER JOIN titles t ON e.emp_no=t.emp_no ORDER BY  e.first_name, e.last_name, d.dept_name, t.from_date;\n\" --verbose\n\n\nelse\n    echo db is not running\n    echo issuing a start\n    sudo systemctl start mysqld\nfi\n\necho cleaning up the DB\n\necho \"\nSHOW DATABASES;     \nDROP DATABASE employees;\nSHOW DATABASES; \n\" | sudo tee \/tmp\/cleanup.txt\n\necho removing files\n\nsudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' < \/tmp\/cleanup.txt\nsudo rm -rf *.dump\nsudo rm -rf employees_db\/*\nsudo rm wget-log\n\ndate","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"4478251d_runbook_cloned_0_cloned_0","main_task_local_reference":{"kind":"app_task","name":"e0273eb3_dag_cloned_1_cloned_1"},"variable_list":[]},"name":"mysqlslap_benchmark_external_DB"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"DB_Status_and_version"}],"name":"a8570e82_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MySQLService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DB_Status_and_version","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Crescenzo Oliviero - System Engineer - Nutanix Rome - Italy\n#\n\ndate\n\nrunning=`sudo systemctl status mysqld | grep \"active (running)\" | wc -l`\nif [ $running = 1 ]; then\n    echo db is running\n    \n    sudo mysql --user=root --password='@@{MYSQL_PASSWORD}@@' -e status \nelse\n    echo db is not running\n    echo issuing a start\n    sudo systemctl start mysqld\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"63bb8ed8_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"a8570e82_dag_cloned_1"},"variable_list":[]},"name":"DB_Status_and_Version"}],"name":"Nutanix","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"INSTANCE_PUBLIC_KEY","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"MYSQL_PASSWORD","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"editables":{"value":true},"is_hidden":false},{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"EPOCH_HOST","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"EPOCH_ORG_ID","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"is_hidden":false}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"WordPress"},"api_version":"3.0","metadata":{"last_update_time":"1569318591112016","kind":"blueprint","spec_version":47,"creation_time":"1568878002036171","categories":{"AppFamily":"Databases"},"name":"WordPress"}}